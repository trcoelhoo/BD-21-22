CREATE SCHEMA SPEM;
GO

CREATE TABLE SPEM.MEDICO(
	numSNS      INT ,
	Nome     VARCHAR(50) ,
	Especialidade VARCHAR(15)
	PRIMARY KEY (numSNS)
);

CREATE TABLE SPEM.PACIENTE(
	NumUtente INT ,
	Nome      VARCHAR(50) ,
	dataNasc  date ,
	Endereco  VARCHAR(50)
	PRIMARY KEY (NumUtente)
);

CREATE TABLE SPEM.Farmacia (
	Nome    VARCHAR(50),
	Telefone char(9),
	Endereco VARCHAR(50)
	PRIMARY KEY(Nome)

);

CREATE TABLE SPEM.PRESCRICAO(
	numPresc    INT,
	numUtente   INT,
	numMedico   INT ,
	farmacia    VARCHAR(50),
	dataProc    date
	PRIMARY KEY (numPresc)
);

CREATE TABLE SPEM.FARMACEUTICA (
	numReg      INT ,
	Nome        VARCHAR(50) ,
	Endereco    VARCHAR(50) 
	PRIMARY KEY(numReg)
);

CREATE TABLE SPEM.FARMACO(
	numRegFarm  INT ,
	Nome        VARCHAR(50) ,
	formula     VARCHAR(15)
	PRIMARY KEY (Nome, numRegFarm),
);

CREATE TABLE SPEM.PRESC_FARMACO(
	numPresc    INT,
	numRegFarm  INT,
	nomeFarmaco VARCHAR(50)
	PRIMARY KEY (nomeFarmaco, numPresc, numRegFarm),
);

ALTER TABLE SPEM.PRESC_FARMACO  ADD constraint FK_nome_numReg FOREIGN KEY (nomeFarmaco, numRegFarm) REFERENCES SPEM.FARMACO(Nome, numRegFarm);
ALTER TABLE SPEM.PRESC_FARMACO  ADD constraint FK_numPresc FOREIGN KEY (numPresc) REFERENCES SPEM.PRESCRICAO(numPresc);
ALTER TABLE SPEM.FARMACO  ADD constraint FK_numRegFarm FOREIGN KEY (numRegFarm) REFERENCES SPEM.FARMACEUTICA(numReg);
ALTER TABLE SPEM.PRESCRICAO  ADD constraint FK_numMedico FOREIGN KEY (numMedico) REFERENCES SPEM.MEDICO(numSNS);
ALTER TABLE SPEM.PRESCRICAO  ADD constraint FK_numUtente FOREIGN KEY (numUtente) REFERENCES SPEM.PACIENTE(NumUtente);
ALTER TABLE SPEM.PRESCRICAO  ADD constraint FK_farmacia FOREIGN KEY (farmacia) REFERENCES SPEM.Farmacia(Nome);

/** b) Introduza dados nas bases de dados criadas. Sugere-se que utilize o dataset fornecido
na última aula (disponível no Moodle); **/

INSERT INTO SPEM.MEDICO VALUES (101,'Joao Pires Lima','Cardiologia');
INSERT INTO SPEM.MEDICO VALUES (102,'Manuel Jose Rosa','Cardiologia');
INSERT INTO SPEM.MEDICO VALUES (103,'Rui Luis Caraca','Pneumologia');
INSERT INTO SPEM.MEDICO VALUES (104,'Sofia Sousa Silva','Radiologia');
INSERT INTO SPEM.MEDICO VALUES (105,'Ana Barbosa', 'Neurologia');
			
INSERT INTO SPEM.PACIENTE VALUES (1,'Renato Manuel Cavaco','1980-01-03','Rua Nova do Pilar 35');
INSERT INTO SPEM.PACIENTE VALUES (2,'Paula Vasco Silva','1972-10-30','Rua Direita 43');
INSERT INTO SPEM.PACIENTE VALUES (3,'Ines Couto Souto','1985-05-12','Rua de Cima 144');
INSERT INTO SPEM.PACIENTE VALUES (4,'Rui Moreira Porto','1970-12-12','Rua Zig Zag 235');
INSERT INTO SPEM.PACIENTE VALUES (5,'Manuel Zeferico Polaco','1990-06-05','n se');
		
INSERT INTO SPEM.Farmacia VALUES ('Farmacia BelaVista',221234567,'Avenida Principal 973');
INSERT INTO SPEM.Farmacia VALUES ('Farmacia Central',234370500,'Avenida da Liberdade 33');
INSERT INTO SPEM.Farmacia VALUES ('Farmacia Peixoto',234375111,'Largo da Vila 523');
INSERT INTO SPEM.Farmacia VALUES ('Farmacia Vitalis',229876543,'Rua Visconde Salgado 263');

INSERT INTO SPEM.FARMACEUTICA VALUES (905,'Roche','Estrada Nacional 249');
INSERT INTO SPEM.FARMACEUTICA VALUES (906,'Bayer','Rua da Quinta do Pinheiro 5');
INSERT INTO SPEM.FARMACEUTICA VALUES (907,'Pfizer','Empreendimento Lagoas Park - Edificio 7');
INSERT INTO SPEM.FARMACEUTICA VALUES (908,'Merck', 'Alameda Fernão Lopes 12');
			
INSERT INTO SPEM.FARMACO VALUES (905,'Boa Saude em 3 Dias','XZT9');
INSERT INTO SPEM.FARMACO VALUES (906,'Voltaren Spray','PLTZ32');
INSERT INTO SPEM.FARMACO VALUES (906,'Xelopironi 350','FRR-34');
INSERT INTO SPEM.FARMACO VALUES (906,'Gucolan 1000','VFR-750');
INSERT INTO SPEM.FARMACO VALUES (907,'GEROaero Rapid','DDFS-XEN9');
INSERT INTO SPEM.FARMACO VALUES (908,'Aspirina 1000','BIOZZ02');

INSERT INTO SPEM.PRESCRICAO VALUES (10001,1,105,'Farmacia Central','2015-03-03');
INSERT INTO SPEM.PRESCRICAO VALUES (10002,1,105,NULL,NULL);
INSERT INTO SPEM.PRESCRICAO VALUES (10003,3,102,'Farmacia Central','2015-01-17');
INSERT INTO SPEM.PRESCRICAO VALUES (10004,3,101,'Farmacia BelaVista','2015-02-09');
INSERT INTO SPEM.PRESCRICAO VALUES (10005,3,102,'Farmacia Central','2015-01-17');
INSERT INTO SPEM.PRESCRICAO VALUES (10006,4,102,'Farmacia Vitalis','2015-02-22');
INSERT INTO SPEM.PRESCRICAO VALUES (10007,5,103,NULL,NULL);
INSERT INTO SPEM.PRESCRICAO VALUES (10008,1,103,'Farmacia Central','2015-01-02');
INSERT INTO SPEM.PRESCRICAO VALUES (10009,3,102,'Farmacia Peixoto','2015-02-02');

INSERT INTO SPEM.PRESC_FARMACO VALUES (10001,905,'Boa Saude em 3 Dias');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10002,907,'GEROaero Rapid');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10003,906,'Voltaren Spray');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10003,906,'Xelopironi 350');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10003,908,'Aspirina 1000');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10004,905,'Boa Saude em 3 Dias');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10004,908,'Aspirina 1000');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10005,906,'Voltaren Spray');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10006,905,'Boa Saude em 3 Dias');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10006,906,'Voltaren Spray');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10006,906,'Xelopironi 350');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10006,908,'Aspirina 1000');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10007,906,'Voltaren Spray');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10008,905,'Boa Saude em 3 Dias');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10008,908,'Aspirina 1000');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10009,905,'Boa Saude em 3 Dias');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10009,906,'Voltaren Spray');
INSERT INTO SPEM.PRESC_FARMACO VALUES (10009,908,'Aspirina 1000');

/** c) Converta as queries AR em queries SQL. **/

/** a) **/
SELECT SPEM.PACIENTE.numUtente, SPEM.PACIENTE.Nome 
FROM SPEM.PACIENTE LEFT OUTER JOIN SPEM.PRESCRICAO ON SPEM.PACIENTE.numUtente=SPEM.PRESCRICAO.numUtente
WHERE SPEM.PRESCRICAO.numUtente IS NULL;

/** b) **/
SELECT SPEM.MEDICO.Especialidade, COUNT(SPEM.MEDICO.Especialidade) AS num_prescricoes
FROM SPEM.MEDICO INNER JOIN SPEM.prescricao ON SPEM.MEDICO.numSNS=SPEM.PRESCRICAO.numMedico
WHERE SPEM.PRESCRICAO.farmacia IS NOT NULL
GROUP BY SPEM.MEDICO.Especialidade;

/** c) **/
SELECT SPEM.PRESCRICAO.farmacia, COUNT(SPEM.PRESCRICAO.farmacia) AS num_precricoes
FROM SPEM.PRESCRICAO
WHERE SPEM.PRESCRICAO.farmacia IS NOT NULL
GROUP BY SPEM.PRESCRICAO.farmacia;

/** d) **/
SELECT SPEM.FARMACO.Nome
FROM SPEM.FARMACEUTICA, SPEM.FARMACO
WHERE SPEM.FARMACEUTICA.numReg=906
EXCEPT (SELECT SPEM.FARMACO.Nome FROM SPEM.FARMACO INNER JOIN SPEM.PRESC_FARMACO ON SPEM.FARMACO.Nome=SPEM.PRESC_FARMACO.nomeFarmaco);

/** e) **/
SELECT SPEM.Farmacia.Nome, SPEM.FARMACEUTICA.Nome, COUNT(SPEM.PRESC_FARMACO.nomeFarmaco) AS num_farmacos_vendidos
FROM SPEM.FARMACEUTICA INNER JOIN (SPEM.PRESC_FARMACO INNER JOIN (SPEM.Farmacia INNER JOIN SPEM.PRESCRICAO ON SPEM.Farmacia.Nome=SPEM.PRESCRICAO.farmacia) ON SPEM.PRESC_FARMACO.numPresc=SPEM.PRESCRICAO.numPresc)  ON SPEM.PRESC_FARMACO.numRegFarm=SPEM.FARMACEUTICA.numReg
GROUP BY SPEM.Farmacia.Nome, SPEM.FARMACEUTICA.Nome;

/** f) **/
SELECT SPEM.PACIENTE.Nome, COUNT(SPEM.PRESCRICAO.numMedico) AS num_medicos
FROM SPEM.PACIENTE INNER JOIN SPEM.PRESCRICAO ON SPEM.PACIENTE.NumUtente=SPEM.PRESCRICAO.numUtente
GROUP BY SPEM.PACIENTE.Nome
HAVING COUNT(SPEM.PRESCRICAO.numMedico)>1;